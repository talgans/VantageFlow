rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isManager() {
      return isAuthenticated() && (request.auth.token.role == 'manager' || request.auth.token.role == 'admin');
    }
    
    // Check if user is project owner or admin
    function isProjectOwner(projectData) {
      return isAuthenticated() && (projectData.ownerId == request.auth.uid || isAdmin());
    }

    // RBAC: Check if current user is in the project's memberUids array
    function isProjectMember(projectData) {
      return isAuthenticated() && (
        isAdmin() ||
        projectData.ownerId == request.auth.uid ||
        (projectData.memberUids != null && request.auth.uid in projectData.memberUids)
      );
    }

    // Check if project is archived
    function isArchived(projectData) {
      return projectData.isArchived == true;
    }

    // Check if update is unarchiving (setting isArchived to false)
    function isUnarchiving() {
      return request.resource.data.isArchived == false && resource.data.isArchived == true;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || request.auth.uid == userId;
    }
    
    // Projects collection - RBAC enforced
    match /projects/{projectId} {
      // Read: Only team members (in memberUids) or admins can read
      // For list queries, client must filter by memberUids containing user.uid
      allow read: if isProjectMember(resource.data);
      
      // Create: Managers and Admins can create projects
      allow create: if isManager();
      
      // Update: Owner/Admin can update, but NOT if archived (unless unarchiving)
      allow update: if isProjectOwner(resource.data) && 
                       (!isArchived(resource.data) || isUnarchiving());
      
      // Delete: Only admins or owner (if manager) can delete
      allow delete: if isAdmin() || (isManager() && resource.data.ownerId == request.auth.uid);
    }
    
    // Invites collection
    match /invites/{email} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Force Logout collection (for role changes)
    match /forceLogout/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAdmin();
    }

    // Notifications
    match /notifications/{notificationId} {
      // User can read their own notifications (both get and list)
      // For list queries, we rely on the client filtering by userId == request.auth.uid
      allow read: if isAuthenticated() && (
        resource == null || resource.data.userId == request.auth.uid
      );
      // User can mark their own notifications as read (update)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Cloud functions (admin SDK) bypass rules, so no create needed here unless client creates.
      allow create: if false; 
    }

    // Achievements - gamification points/badges (public for authenticated users)
    match /achievements/{achievementId} {
      // Any authenticated user can read achievements (displayed for team members)
      allow read: if isAuthenticated();
      // Creation: currently client-side 'achievementService' calls addDoc.
      allow create: if isAuthenticated();
      // Only admin can modify/delete history
      allow update, delete: if isAdmin();
    }

    // Role Permissions configuration
    match /rolePermissions/{docId} {
      // All authenticated users can read permissions (needed to check their role's capabilities)
      allow read: if isAuthenticated();
      // Only admins can modify permission configurations
      allow write: if isAdmin();
    }
  }
}
