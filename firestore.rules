rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && request.auth.token.role == 'admin';
    }
    
    function isManager() {
      return isAuthenticated() && (request.auth.token.role == 'manager' || request.auth.token.role == 'admin');
    }
    
    // Check if user is project owner or admin
    function isProjectOwner(projectData) {
      return isAuthenticated() && (projectData.ownerId == request.auth.uid || isAdmin());
    }

    // Check if user is a member of the project team
    function isTeamMember(projectData) {
      return isAuthenticated() && (
        projectData.team.members.hasAny([{'uid': request.auth.uid}]) ||
        // Check if UID is in the members array (simplified check if structure varies, ideally specific)
        // For array of maps, it's harder to check membership by field in rules without complex logic.
        // Simplified: allow read if authenticated for now for projects list, 
        // but strict read is better.
        // Existing rules likely allowed read if authenticated.
        true 
      );
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || request.auth.uid == userId;
    }
    
    // Projects collection
    match /projects/{projectId} {
      allow read: if isAuthenticated();
      // Only Managers and Admins can create projects
      allow create: if isManager();
      // Project Owner and Admins can update/delete
      // Also allow updates if user is in the team? Maybe restricted updates?
      // For assignments, we currently rely on 'canEdit' in UI which checks owner/admin.
      allow update: if isProjectOwner(resource.data);
      allow delete: if isAdmin() || (isManager() && resource.data.ownerId == request.auth.uid);
    }
    
    // Invites collection
    match /invites/{email} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Force Logout collection (for role changes)
    match /forceLogout/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAdmin();
    }

    // Notifications
    match /notifications/{notificationId} {
      // User can read their own notifications (both get and list)
      // For list queries, we rely on the client filtering by userId == request.auth.uid
      allow read: if isAuthenticated() && (
        resource == null || resource.data.userId == request.auth.uid
      );
      // User can mark their own notifications as read (update)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Cloud functions (admin SDK) bypass rules, so no create needed here unless client creates.
      allow create: if false; 
    }

    // Achievements - gamification points/badges (public for authenticated users)
    match /achievements/{achievementId} {
      // Any authenticated user can read achievements (displayed for team members)
      allow read: if isAuthenticated();
      // Creation: currently client-side 'achievementService' calls addDoc.
      allow create: if isAuthenticated();
      // Only admin can modify/delete history
      allow update, delete: if isAdmin();
    }
  }
}
